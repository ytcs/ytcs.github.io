<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Company Valuation Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1f2937;
            --secondary-color: #374151;
            --tertiary-color: #4b5563;
            --accent-color: #3b82f6;
            --accent-light: #60a5fa;
            --accent-dark: #1d4ed8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background-color: #f9fafb;
            --surface-color: #ffffff;
            --surface-elevated: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --border-light: #f3f4f6;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.125rem;
        }

        .header .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .ticker-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ticker-selector label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .ticker-selector select {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .ticker-selector select option {
            background: var(--primary-color);
            color: white;
        }

        .card {
            background: var(--surface-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card-header {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .card-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .market-data-container {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 2rem;
            color: white;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 1.5rem;
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .compact-metric {
            text-align: center;
            padding: 0;
        }

        .compact-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.25rem;
            display: block;
        }

        .compact-metric-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            display: block;
        }

        .price-status {
            font-size: 0.6rem;
            font-weight: 500;
            margin-top: 0.25rem;
            text-align: center;
            opacity: 0.8;
        }

        .price-status.live-indicator {
            color: rgba(255, 255, 255, 0.9);
        }

        .price-status.static-indicator {
            color: rgba(255, 255, 255, 0.6);
        }

        .refresh-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 1.2rem;
            height: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: rotate(180deg);
        }

        .refresh-btn:active {
            transform: rotate(180deg) scale(0.95);
        }

        .integrated-filters {
            background: var(--surface-elevated);
            padding: 1.25rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-light);
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 0.5rem;
            max-width: 100%;
        }

        @media (max-width: 768px) {
            .filter-buttons {
                grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
                gap: 0.4rem;
            }
        }

        .filter-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .filter-btn:hover {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
            box-shadow: var(--shadow);
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: var(--shadow);
        }

        /* Search input styles removed - no longer needed */

        .sort-controls {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .sort-btn:hover {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
            box-shadow: var(--shadow);
        }

        .sort-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: var(--shadow);
        }

        .scenario-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem;
        }

        .scenario-table th,
        .scenario-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .scenario-table th {
            background: var(--surface-elevated);
            font-weight: 600;
            color: var(--text-primary);
        }

        .scenario-table tbody tr:hover {
            background-color: var(--surface-elevated);
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .sortable:hover {
            background-color: var(--accent-color);
            color: white;
        }

        .mcf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .mcf-item {
            background: var(--surface-color);
            padding: 1.25rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .mcf-name {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.4;
        }

        .mcf-driver {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .driver-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .driver-value {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-style: italic;
        }

        .distribution-summary {
            background: var(--surface-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
            box-shadow: var(--shadow);
        }

        .dist-stat {
            text-align: center;
            flex: 1;
            min-width: 80px;
        }

        .dist-stat-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
            display: block;
        }

        .dist-stat-label {
            color: var(--text-muted);
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            display: block;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        .chart-container-large {
            position: relative;
            height: 450px;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .scenario-table th,
            .scenario-table td {
                padding: 0.4rem;
                font-size: 0.8rem;
            }
            
            .chart-container, .chart-container-large {
                height: 280px;
            }
            
            .filter-buttons, .sort-controls {
                justify-content: center;
            }

            .grid-4 {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div>
                    <h1 id="companyName">Company Valuation Dashboard</h1>
                    <div class="subtitle" id="valuationInfo">Interactive Valuation Dashboard</div>
                </div>
                <div class="ticker-selector">
                    <label for="tickerSelect">Company:</label>
                    <select id="tickerSelect">
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContent">
        <div class="loading">Please select a company to view valuation data.</div>
    </div>

    <script>
        let valuationData = null;
        let filteredScenarios = [];
        let activeFilters = {};
        let currentSort = { field: 'price', direction: 'desc' };
        let distributionChart = null;
        let availableTickers = [];
        let currentTicker = '';
        // Add live pricing variables
        let livePriceInterval = null;
        let lastPriceUpdate = null;
        let isMarketHours = false;
        let originalPrice = null; // Store original static price
        const ALPHA_VANTAGE_API_KEY = '51W3A3YC92ML9EXM';
        let requestCount = 0;
        let requestWindow = Date.now();

        async function loadAvailableTickers() {
            try {
                // Load the index file to get available tickers
                const indexResponse = await fetch('./data/index.json');
                if (!indexResponse.ok) {
                    throw new Error('Could not load company index');
                }
                
                const tickerList = await indexResponse.json();
                
                // Load company information from each ticker's data file
                availableTickers = [];
                for (const ticker of tickerList) {
                    try {
                        const response = await fetch(`./data/${ticker}.json`);
                        if (response.ok) {
                            const data = await response.json();
                            availableTickers.push({
                                ticker: ticker,
                                companyName: data.metadata?.company_name || ticker
                            });
                        }
                    } catch (e) {
                        console.log(`Data file ${ticker}.json not found`);
                    }
                }

                // Populate ticker selector
                const tickerSelect = document.getElementById('tickerSelect');
                tickerSelect.innerHTML = '<option value="">Select a company...</option>';
                
                availableTickers.forEach((company) => {
                    const option = document.createElement('option');
                    option.value = company.ticker;
                    option.textContent = `${company.companyName} (${company.ticker})`;
                    tickerSelect.appendChild(option);
                });

                // Add event listener
                tickerSelect.addEventListener('change', (e) => {
                    if (e.target.value) {
                        loadTickerData(e.target.value);
                    } else {
                        clearDashboard();
                    }
                });

                // Auto-load first ticker if available
                if (availableTickers.length > 0) {
                    tickerSelect.value = availableTickers[0].ticker;
                    loadTickerData(availableTickers[0].ticker);
                }

            } catch (error) {
                console.error('Error loading available tickers:', error);
                document.getElementById('tickerSelect').innerHTML = '<option value="">Error loading companies</option>';
            }
        }

        async function loadTickerData(ticker) {
            if (!ticker) return;
            
            currentTicker = ticker;
            showLoading();
            
            try {
                const response = await fetch(`./data/${ticker}.json`);
                if (!response.ok) {
                    throw new Error(`Failed to load data for ${ticker}`);
                }
                
                valuationData = await response.json();
                initializeDashboard();
            } catch (error) {
                console.error(`Error loading data for ${ticker}:`, error);
                showError(`Failed to load data for ${ticker}. Please ensure ${ticker}.json exists in the data folder.`);
            }
        }

        function showLoading() {
            document.getElementById('mainContent').innerHTML = '<div class="loading">Loading valuation data...</div>';
        }

        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="error-message">
                    <h3>Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        function clearDashboard() {
            // Stop live pricing for the previous ticker
            stopLivePricing();
            
            document.getElementById('mainContent').innerHTML = '<div class="loading">Please select a company to view valuation data.</div>';
            document.getElementById('companyName').textContent = 'Company Valuation Dashboard';
            document.getElementById('valuationInfo').textContent = 'Interactive Valuation Dashboard';
            document.getElementById('pageTitle').textContent = 'Company Valuation Dashboard';
        }

        function initializeDashboard() {
            if (!valuationData) return;

            // Store original static price
            originalPrice = valuationData.market_data_used?.stock_price || 0;

            // Update page title and header
            const companyName = valuationData.metadata?.company_name || currentTicker;
            const ticker = valuationData.metadata?.ticker || currentTicker;
            
            document.getElementById('pageTitle').textContent = `${ticker} Valuation Dashboard`;
            document.getElementById('companyName').textContent = `${companyName} (${ticker})`;
            document.getElementById('valuationInfo').textContent = `Valuation as of ${valuationData.metadata?.valuation_date || 'N/A'} • ${valuationData.valuation_scenarios?.length || 0} Scenarios • Next Earnings: ${valuationData.metadata?.next_earnings_date || 'N/A'}`;

            // Create main dashboard content
            document.getElementById('mainContent').innerHTML = `
                <!-- Market Data -->
                <div id="marketData">
                    <div class="loading">Loading market data...</div>
                </div>

                <!-- Distribution Analysis with Interactive Plot -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Valuation Distribution Analysis</h2>
                        <p class="card-description">Price distribution with log-normal fit and 5% VaR</p>
                    </div>
                    <div class="distribution-summary" id="distributionSummary">
                        <div class="loading">Loading statistics...</div>
                    </div>
                    <div class="chart-container-large">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>

                <!-- MCF Overview -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Major Current Factors (MCFs)</h2>
                        <p class="card-description">Key drivers of valuation scenarios</p>
                    </div>
                    <div class="mcf-grid" id="mcfGrid">
                        <div class="loading">Loading MCFs...</div>
                    </div>
                </div>

                <!-- Financial Projections -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Financial Projections</h2>
                        <p class="card-description">5-year revenue and free cash flow forecasts across scenarios</p>
                    </div>
                    <div class="grid grid-2">
                        <div>
                            <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">Revenue Projections</h4>
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">Free Cash Flow Projections</h4>
                            <div class="chart-container">
                                <canvas id="fcfChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scenario Analysis with Integrated Filters -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Scenario Analysis & Filtering</h2>
                        <p class="card-description">Filter and analyze valuation outcomes for each MCF combination</p>
                    </div>
                    
                    <!-- Integrated Filter Section -->
                    <div class="integrated-filters" id="scenarioFilters">
                        <h3 style="margin-bottom: 1rem; font-size: 1rem; color: var(--text-primary);">Filter by MCF Scenarios</h3>
                        <div id="filterControls">
                            <div class="loading">Loading filters...</div>
                        </div>
                    </div>
                    
                    <div class="sort-controls">
                        <span style="font-weight: 500; font-size: 0.9rem;">Sort by:</span>
                        <button class="sort-btn active" onclick="sortScenarios('price')">Share Price</button>
                        <button class="sort-btn" onclick="sortScenarios('upside')">Upside %</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="scenario-table" id="scenarioTable">
                            <thead>
                                <tr>
                                    <th>Scenario</th>
                                    <th>MCF Combination</th>
                                    <th class="sortable" onclick="sortTable('price')">Implied Share Price</th>
                                    <th class="sortable" onclick="sortTable('upside')">vs Current Price</th>
                                </tr>
                            </thead>
                            <tbody id="scenarioTableBody">
                                <tr><td colspan="4" class="loading">Loading scenarios...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Initialize all sections
            renderMarketData();
            renderDistributionSummary();
            initializeDistributionChart();
            renderMCFs();
            renderFilters();
            initializeFinancialCharts();
            
            filteredScenarios = valuationData.valuation_scenarios || [];
            sortAndRenderScenarios();
            
            // Search functionality removed since scenarios are unnamed

            // Start live pricing
            startLivePricing();
        }

        // Rate limiting for Alpha Vantage (5 requests per minute free tier)
        function canMakeRequest() {
            const now = Date.now();
            const timeSinceWindow = now - requestWindow;
            
            // Reset counter every minute
            if (timeSinceWindow > 60000) {
                requestCount = 0;
                requestWindow = now;
            }
            
            // Allow max 4 requests per minute to stay under limit
            return requestCount < 4;
        }

        // Alpha Vantage live pricing function
        async function fetchLivePrice(ticker) {
            try {
                // Check rate limit
                if (!canMakeRequest()) {
                    console.log('Rate limit reached, using cached price');
                    return {
                        price: valuationData.market_data_used?.stock_price || originalPrice,
                        marketState: isMarketOpen() ? 'REGULAR' : 'CLOSED',
                        success: false,
                        error: 'Rate limited'
                    };
                }

                requestCount++;
                
                const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${ticker}&apikey=${ALPHA_VANTAGE_API_KEY}`;
                console.log(`Fetching live price from Alpha Vantage for ${ticker}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check for API errors
                if (data['Error Message']) {
                    throw new Error(`Alpha Vantage error: ${data['Error Message']}`);
                }
                
                if (data['Note']) {
                    console.warn(`Alpha Vantage note: ${data['Note']}`);
                    return {
                        price: valuationData.market_data_used?.stock_price || originalPrice,
                        marketState: isMarketOpen() ? 'REGULAR' : 'CLOSED',
                        success: false,
                        error: 'API call frequency limit reached'
                    };
                }
                
                // Parse Global Quote response
                const quote = data['Global Quote'];
                if (quote && quote['05. price']) {
                    const price = parseFloat(quote['05. price']);
                    const changePercent = parseFloat(quote['10. change percent'].replace('%', ''));
                    const volume = parseInt(quote['06. volume']);
                    const lastUpdate = quote['07. latest trading day'];
                    
                    console.log(`Successfully fetched Alpha Vantage price: $${price}`);
                    
                    return {
                        price: price,
                        changePercent: changePercent,
                        volume: volume,
                        lastUpdate: lastUpdate,
                        marketState: isMarketOpen() ? 'REGULAR' : 'CLOSED',
                        success: true,
                        source: 'Alpha Vantage'
                    };
                } else {
                    throw new Error('Invalid response format from Alpha Vantage');
                }
                
            } catch (error) {
                console.error('Error fetching live price from Alpha Vantage:', error);
                return {
                    price: originalPrice,
                    marketState: 'CLOSED',
                    success: false,
                    error: error.message
                };
            }
        }

        function isMarketOpen() {
            const now = new Date();
            const et = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            const day = et.getDay(); // 0 = Sunday, 6 = Saturday
            const hour = et.getHours();
            const minute = et.getMinutes();
            const time = hour * 100 + minute;
            
            // Monday (1) to Friday (5), 9:30 AM to 4:00 PM ET
            return day >= 1 && day <= 5 && time >= 930 && time <= 1600;
        }

        function updatePriceDisplay(priceData) {
            if (!valuationData || !valuationData.market_data_used) return;
            
            // Update the market data with new price
            valuationData.market_data_used.stock_price = priceData.price;
            
            // Update last price update timestamp
            lastPriceUpdate = new Date();
            
            // Re-render all components that depend on current price
            renderMarketData();
            renderDistributionSummary();
            sortAndRenderScenarios();
            
            // Update the market status in the header
            updateMarketStatus(priceData);
        }

        function updateMarketStatus(priceData) {
            const statusElement = document.getElementById('priceStatus');
            if (statusElement) {
                let statusText = '';
                let statusClass = '';
                
                if (priceData.success) {
                    statusText = 'LIVE';
                    statusClass = 'live-indicator';
                    
                    // Add change indicator if available
                    if (priceData.changePercent !== undefined) {
                        const changeSign = priceData.changePercent >= 0 ? '+' : '';
                        statusText += ` (${changeSign}${priceData.changePercent.toFixed(2)}%)`;
                    }
                } else {
                    statusText = 'STATIC';
                    statusClass = 'static-indicator';
                }
                
                statusElement.innerHTML = statusText;
                statusElement.className = `price-status ${statusClass}`;
            }
        }

        async function updateLivePrice() {
            if (!currentTicker) return;
            
            const priceData = await fetchLivePrice(currentTicker);
            updatePriceDisplay(priceData);
        }

        function startLivePricing() {
            if (!currentTicker) return;
            
            // Clear existing interval
            if (livePriceInterval) {
                clearInterval(livePriceInterval);
            }
            
            // Initial price fetch
            updateLivePrice();
            
            // Set up interval - Alpha Vantage rate limit friendly
            // Update every 2 minutes during market hours, every 10 minutes otherwise
            const updateInterval = isMarketOpen() ? 120000 : 600000; // 2min or 10min
            livePriceInterval = setInterval(updateLivePrice, updateInterval);
            
            console.log(`Started live pricing for ${currentTicker} with ${updateInterval/1000}s intervals`);
        }

        function stopLivePricing() {
            if (livePriceInterval) {
                clearInterval(livePriceInterval);
                livePriceInterval = null;
            }
        }

        function resetToStaticPrice() {
            if (!valuationData || !valuationData.market_data_used || !originalPrice) return;
            
            valuationData.market_data_used.stock_price = originalPrice;
            renderMarketData();
            renderDistributionSummary();
            sortAndRenderScenarios();
            
            const statusElement = document.getElementById('priceStatus');
            if (statusElement) {
                statusElement.innerHTML = 'STATIC';
                statusElement.className = 'price-status static-indicator';
            }
        }

        function renderMarketData() {
            const marketData = valuationData.market_data_used;
            const container = document.getElementById('marketData');
            
            if (!marketData) {
                container.innerHTML = '<div class="error-message">Market data not available</div>';
                return;
            }
            
            container.innerHTML = `
                <div class="market-data-container">
                    <button id="refreshPrice" class="refresh-btn" onclick="updateLivePrice()" title="Refresh Price">
                        ↻
                    </button>
                    <div class="compact-metric">
                        <div class="compact-metric-value">$${(marketData.stock_price || 0).toFixed(2)}</div>
                        <div class="compact-metric-label">Current Price</div>
                        <div id="priceStatus" class="price-status">Loading...</div>
                    </div>
                    <div class="compact-metric">
                        <div class="compact-metric-value">${((marketData.wacc_consensus || 0) * 100).toFixed(1)}%</div>
                        <div class="compact-metric-label">WACC</div>
                    </div>
                    <div class="compact-metric">
                        <div class="compact-metric-value">${((marketData.risk_free_rate || 0) * 100).toFixed(1)}%</div>
                        <div class="compact-metric-label">Risk Free Rate</div>
                    </div>
                    <div class="compact-metric">
                        <div class="compact-metric-value">${((marketData.terminal_growth_rate || 0) * 100).toFixed(1)}%</div>
                        <div class="compact-metric-label">Terminal Growth</div>
                    </div>
                </div>
            `;
        }

        function renderDistributionSummary() {
            const scenarios = valuationData.valuation_scenarios || [];
            if (scenarios.length === 0) {
                document.getElementById('distributionSummary').innerHTML = '<div class="error-message">No scenario data available</div>';
                return;
            }

            const prices = scenarios.map(s => s.valuation_results?.implied_share_price || 0).filter(p => p > 0);
            const currentPrice = valuationData.market_data_used?.stock_price || 0;
            
            // Calculate statistics
            const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
            const variance = prices.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / prices.length;
            const stdDev = Math.sqrt(variance);
            const sortedPrices = [...prices].sort((a, b) => a - b);
            
            const p5 = sortedPrices[Math.floor(prices.length * 0.05)];
            const p25 = sortedPrices[Math.floor(prices.length * 0.25)];
            const median = sortedPrices[Math.floor(prices.length * 0.5)];
            const p75 = sortedPrices[Math.floor(prices.length * 0.75)];
            const p95 = sortedPrices[Math.floor(prices.length * 0.95)];
            const upside = currentPrice > 0 ? ((mean - currentPrice) / currentPrice * 100) : 0;

            document.getElementById('distributionSummary').innerHTML = `
                <div class="dist-stat">
                    <div class="dist-stat-value">$${p5.toFixed(2)}</div>
                    <div class="dist-stat-label">5% VAR</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${p25.toFixed(2)}</div>
                    <div class="dist-stat-label">P25</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${median.toFixed(2)}</div>
                    <div class="dist-stat-label">MEDIAN</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${p75.toFixed(2)}</div>
                    <div class="dist-stat-label">P75</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${p95.toFixed(2)}</div>
                    <div class="dist-stat-label">P95</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${mean.toFixed(2)}</div>
                    <div class="dist-stat-label">MEAN</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">${stdDev.toFixed(2)}</div>
                    <div class="dist-stat-label">STD DEV</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">${upside.toFixed(1)}%</div>
                    <div class="dist-stat-label">MEAN UPSIDE</div>
                </div>
            `;
        }

        function initializeDistributionChart() {
            const scenarios = valuationData.valuation_scenarios || [];
            if (scenarios.length === 0) return;

            const prices = scenarios.map(s => s.valuation_results?.implied_share_price || 0).filter(p => p > 0);
            const currentPrice = valuationData.market_data_used?.stock_price || 0;
            
            if (prices.length === 0) return;

            // Calculate statistics
            const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
            const variance = prices.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / prices.length;
            const stdDev = Math.sqrt(variance);
            const sortedPrices = [...prices].sort((a, b) => a - b);
            const stats = {
                mean: mean,
                stdDev: stdDev,
                p5: sortedPrices[Math.floor(prices.length * 0.05)],
                p95: sortedPrices[Math.floor(prices.length * 0.95)]
            };

            // Create histogram
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const binCount = Math.min(20, Math.max(10, Math.floor(prices.length / 5)));
            const binSize = (maxPrice - minPrice) / binCount;
            
            const histogram = new Array(binCount).fill(0);
            prices.forEach(price => {
                const binIndex = Math.min(binCount - 1, Math.floor((price - minPrice) / binSize));
                histogram[binIndex]++;
            });

            const labels = [];
            const histogramData = [];
            for (let i = 0; i < binCount; i++) {
                const binStart = minPrice + i * binSize;
                const binEnd = binStart + binSize;
                labels.push(`$${binStart.toFixed(0)}-${binEnd.toFixed(0)}`);
                histogramData.push(histogram[i]);
            }

            // Create log-normal fit
            const logMean = Math.log(mean);
            const logStd = Math.log(1 + (stdDev / mean) ** 2) ** 0.5;
            
            const logNormalData = [];
            for (let i = 0; i < binCount; i++) {
                const x = minPrice + (i + 0.5) * binSize;
                if (x > 0) {
                    const logNormalValue = (prices.length * binSize) / (x * logStd * Math.sqrt(2 * Math.PI)) * 
                                         Math.exp(-Math.pow(Math.log(x) - logMean, 2) / (2 * logStd * logStd));
                    logNormalData.push(logNormalValue);
                } else {
                    logNormalData.push(0);
                }
            }

            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (distributionChart) {
                distributionChart.destroy();
            }
            
            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Scenario Count',
                        data: histogramData,
                        backgroundColor: 'rgba(37, 99, 235, 0.6)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'Log-Normal Fit',
                        data: logNormalData,
                        type: 'line',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Valuation Distribution (Current: $${currentPrice.toFixed(2)}, Mean: $${stats.mean.toFixed(2)}, σ: $${stats.stdDev.toFixed(2)})`
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterLabel: function(context) {
                                    const price = minPrice + (context.dataIndex + 0.5) * binSize;
                                    const logPrice = Math.log(price);
                                    const pValue = 0.5 * (1 + erf((logPrice - logMean) / (logStd * Math.sqrt(2))));
                                    return `P-value: ${(pValue * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frequency'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Share Price ($)'
                            }
                        }
                    }
                }
            });
        }

        // Error function approximation for p-value calculation
        function erf(x) {
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;
            
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x);
            
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            
            return sign * y;
        }

        function renderMCFs() {
            const mcfs = valuationData.mcf_summary || [];
            const container = document.getElementById('mcfGrid');
            
            if (mcfs.length === 0) {
                container.innerHTML = '<div class="error-message">No MCF data available</div>';
                return;
            }

            container.innerHTML = mcfs.map(mcf => `
                <div class="mcf-item">
                    <div class="mcf-name">${mcf.mcf_name || 'Unnamed MCF'}</div>
                    <div class="mcf-driver">
                        <span class="driver-label">Model Driver:</span>
                        <span class="driver-value">${mcf.model_driver_mapping || 'Not specified'}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderFilters() {
            const mcfs = valuationData.mcf_summary || [];
            const container = document.getElementById('filterControls');
            
            if (mcfs.length === 0) {
                container.innerHTML = '<div class="error-message">No filter options available</div>';
                return;
            }

            // Extract unique scenario choices to determine available options for each MCF
            const scenarios = valuationData.valuation_scenarios || [];
            const mcfOptions = {};
            
            scenarios.forEach(scenario => {
                if (scenario.scenario_choices) {
                    Object.entries(scenario.scenario_choices).forEach(([mcfId, choice]) => {
                        if (!mcfOptions[mcfId]) {
                            mcfOptions[mcfId] = new Set();
                        }
                        mcfOptions[mcfId].add(choice);
                    });
                }
            });

            container.innerHTML = mcfs.map(mcf => `
                <div class="filter-group">
                    <label class="filter-label">${mcf.mcf_name || 'Unnamed MCF'}</label>
                    <div class="filter-buttons">
                        ${Array.from(mcfOptions[mcf.mcf_id] || []).map(option => 
                            `<button class="filter-btn" onclick="toggleFilterById('${mcf.mcf_id}', '${option}')" data-mcf-id="${mcf.mcf_id}" data-option="${option}">${option}</button>`
                        ).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleFilterById(mcfId, option) {
            if (!activeFilters[mcfId]) {
                activeFilters[mcfId] = new Set();
            }
            
            if (activeFilters[mcfId].has(option)) {
                activeFilters[mcfId].delete(option);
                // Clean up empty filter sets
                if (activeFilters[mcfId].size === 0) {
                    delete activeFilters[mcfId];
                }
            } else {
                activeFilters[mcfId].add(option);
            }
            
            // Update button states
            const button = document.querySelector(`[data-mcf-id="${mcfId}"][data-option="${option}"]`);
            if (button) {
                button.classList.toggle('active');
            }
            
            console.log('Active filters:', activeFilters);
            applyFilters();
        }

        // Keep old function for backward compatibility
        function toggleFilter(mcfName, option) {
            const mcf = (valuationData.mcf_summary || []).find(m => m.mcf_name === mcfName);
            if (mcf) {
                toggleFilterById(mcf.mcf_id, option);
            }
        }

        function applyFilters() {
            const scenarios = valuationData.valuation_scenarios || [];
            
            filteredScenarios = scenarios.filter(scenario => {
                // If no filters are active, show all scenarios
                if (Object.keys(activeFilters).length === 0) return true;
                
                for (const [mcfId, selectedOptions] of Object.entries(activeFilters)) {
                    if (selectedOptions.size > 0) {
                        // Check if the scenario has one of the selected options for this MCF
                        const scenarioChoice = scenario.scenario_choices?.[mcfId];
                        if (!scenarioChoice || !selectedOptions.has(scenarioChoice)) {
                            return false;
                        }
                    }
                }
                
                return true;
            });
            
            sortAndRenderScenarios();
        }

        // handleSearch function removed - search functionality not needed for unnamed scenarios

        function sortScenarios(field) {
            // Update active sort button
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc';
            }
            
            sortAndRenderScenarios();
        }

        function sortAndRenderScenarios() {
            if (!filteredScenarios || filteredScenarios.length === 0) {
                document.getElementById('scenarioTableBody').innerHTML = '<tr><td colspan="4">No scenarios available</td></tr>';
                return;
            }

            const currentPrice = valuationData.market_data_used?.stock_price || 0;
            
            // Sort scenarios
            filteredScenarios.sort((a, b) => {
                let aVal, bVal;
                
                switch (currentSort.field) {
                    case 'price':
                        aVal = a.valuation_results?.implied_share_price || 0;
                        bVal = b.valuation_results?.implied_share_price || 0;
                        break;
                    case 'upside':
                        aVal = currentPrice > 0 ? ((a.valuation_results?.implied_share_price || 0) - currentPrice) / currentPrice : 0;
                        bVal = currentPrice > 0 ? ((b.valuation_results?.implied_share_price || 0) - currentPrice) / currentPrice : 0;
                        break;
                    default:
                        return 0;
                }
                
                return currentSort.direction === 'desc' ? bVal - aVal : aVal - bVal;
            });
            
            // Render scenarios
            const tbody = document.getElementById('scenarioTableBody');
            tbody.innerHTML = filteredScenarios.map((scenario, index) => {
                const price = scenario.valuation_results?.implied_share_price || 0;
                const upside = currentPrice > 0 ? ((price - currentPrice) / currentPrice * 100) : 0;
                const upsideClass = upside >= 0 ? 'success' : 'danger';
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="font-size: 0.8rem;">${scenario.scenario_name || 'Unknown'}</td>
                        <td><strong>$${price.toFixed(2)}</strong></td>
                        <td><span style="color: var(--${upsideClass}-color); font-weight: 600;">${upside >= 0 ? '+' : ''}${upside.toFixed(1)}%</span></td>
                    </tr>
                `;
            }).join('');
        }

        function initializeFinancialCharts() {
            const scenarios = valuationData.valuation_scenarios || [];
            if (scenarios.length === 0) return;

            // Get sample scenarios for visualization
            const sortedByPrice = [...scenarios].sort((a, b) => (b.valuation_results?.implied_share_price || 0) - (a.valuation_results?.implied_share_price || 0));
            const sampleScenarios = [
                {
                    scenario: sortedByPrice[0], // Highest valuation
                    label: 'Best Case',
                    color: 'rgba(34, 197, 94, 0.8)'
                },
                {
                    scenario: scenarios.find(s => (s.scenario_name || '').includes('Base, Base, Base, Base')) || scenarios[Math.floor(scenarios.length/2)],
                    label: 'Consensus',
                    color: 'rgba(59, 130, 246, 0.8)'
                },
                {
                    scenario: sortedByPrice[sortedByPrice.length - 1], // Lowest valuation
                    label: 'Worst Case',
                    color: 'rgba(239, 68, 68, 0.8)'
                }
            ].filter(item => item.scenario && item.scenario.forecast_summary);
            
            if (sampleScenarios.length === 0) return;
            
            const years = ['2025', '2026', '2027', '2028', '2029'];
            
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart')?.getContext('2d');
            if (revenueCtx) {
                new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: sampleScenarios.map((item) => ({
                            label: item.label,
                            data: years.map(year => (item.scenario.forecast_summary?.revenue?.[year] || 0) / 1000),
                            borderColor: item.color,
                            backgroundColor: item.color.replace('0.8', '0.1'),
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Revenue (Billions USD)'
                                }
                            }
                        }
                    }
                });
            }
            
            // FCF Chart
            const fcfCtx = document.getElementById('fcfChart')?.getContext('2d');
            if (fcfCtx) {
                new Chart(fcfCtx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: sampleScenarios.map((item) => ({
                            label: item.label,
                            data: years.map(year => (item.scenario.forecast_summary?.unlevered_fcf?.[year] || 0) / 1000),
                            borderColor: item.color,
                            backgroundColor: item.color.replace('0.8', '0.1'),
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Free Cash Flow (Billions USD)'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Load available tickers when page loads
        document.addEventListener('DOMContentLoaded', loadAvailableTickers);

        // Cleanup live pricing when page unloads
        window.addEventListener('beforeunload', stopLivePricing);
    </script>
</body>
</html> 