<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSY Valuation Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #8B4513;
            --secondary-color: #A0522D;
            --tertiary-color: #D2691E;
            --success-color: #CD853F;
            --warning-color: #DEB887;
            --danger-color: #B22222;
            --background-color: #FFF8DC;
            --surface-color: #FFFEF7;
            --text-primary: #3E2723;
            --text-secondary: #795548;
            --border-color: #DDBF94;
            --accent-gold: #DAA520;
            --chocolate-dark: #654321;
            --chocolate-medium: #8B4513;
            --chocolate-light: #D2691E;
            --cream: #F5F5DC;
            --shadow: 0 1px 3px 0 rgb(101 67 33 / 0.15), 0 1px 2px -1px rgb(101 67 33 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(101 67 33 / 0.15), 0 4px 6px -4px rgb(101 67 33 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 1.5rem;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .header .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .card {
            background: var(--surface-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card-header {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .card-description {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .compact-metric {
            text-align: center;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--cream), var(--warning-color));
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .compact-metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .compact-metric-label {
            color: var(--text-secondary);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .filters {
            background: var(--surface-color);
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .filter-group {
            margin-bottom: 0.75rem;
        }

        .filter-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .filter-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .scenario-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem;
        }

        .scenario-table th,
        .scenario-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .scenario-table th {
            background: var(--background-color);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }

        .scenario-table th:hover {
            background: var(--border-color);
        }

        .scenario-table th.sortable::after {
            content: ' ↕';
            opacity: 0.5;
        }

        .scenario-table th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
        }

        .scenario-table th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
        }

        .scenario-table tbody tr:hover {
            background: var(--background-color);
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 0.75rem;
        }

        .chart-container-large {
            position: relative;
            height: 400px;
            margin-top: 0.75rem;
        }

        .mcf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .mcf-card {
            padding: 0.75rem;
            background: var(--background-color);
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .mcf-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .mcf-mapping {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .scenario-badge {
            display: inline-block;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-right: 0.2rem;
        }

        .badge-bull {
            background: #F0E68C;
            color: #654321;
        }

        .badge-base {
            background: #DEB887;
            color: #3E2723;
        }

        .badge-bear {
            background: #D2691E;
            color: #FFFEF7;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
            color: var(--text-secondary);
        }

        .sort-controls {
            margin: 0.75rem 0;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .sort-btn:hover, .sort-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .search-input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(139 69 19 / 0.15);
        }

        .price-vs-current {
            font-size: 0.8rem;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-weight: 500;
        }

        .price-above {
            background: #F0E68C;
            color: #654321;
        }

        .price-below {
            background: #D2691E;
            color: #FFFEF7;
        }

        .distribution-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--background-color);
            border-radius: 6px;
        }

        .dist-stat {
            text-align: center;
        }

        .dist-stat-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .dist-stat-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header .subtitle {
                font-size: 0.9rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .scenario-table {
                font-size: 0.8rem;
            }
            
            .scenario-table th,
            .scenario-table td {
                padding: 0.4rem;
            }
            
            .chart-container, .chart-container-large {
                height: 280px;
            }
            
            .filter-buttons {
                justify-content: center;
            }

            .grid-4 {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 id="companyName">Loading...</h1>
            <div class="subtitle" id="valuationInfo">Interactive Valuation Dashboard</div>
        </div>
    </div>

    <div class="container">
        <!-- Compact Market Data -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Market Data</h2>
                <p class="card-description">Key valuation inputs</p>
            </div>
            <div class="grid grid-4" id="marketData">
                <div class="loading">Loading market data...</div>
            </div>
        </div>

        <!-- Distribution Analysis with Interactive Plot -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Valuation Distribution Analysis</h2>
                <p class="card-description">Price distribution with log-normal fit and 5% VaR</p>
            </div>
            <div class="distribution-summary" id="distributionSummary">
                <div class="loading">Loading statistics...</div>
            </div>
            <div class="chart-container-large">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>

        <!-- MCF Overview -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Major Current Factors (MCFs)</h2>
                <p class="card-description">Key drivers of valuation scenarios</p>
            </div>
            <div class="mcf-grid" id="mcfGrid">
                <div class="loading">Loading MCFs...</div>
            </div>
        </div>

        <!-- Financial Projections -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Financial Projections</h2>
                <p class="card-description">5-year revenue and free cash flow forecasts across scenarios</p>
            </div>
            <div class="grid grid-2">
                <div>
                    <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">Revenue Projections</h4>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div>
                    <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">Free Cash Flow Projections</h4>
                    <div class="chart-container">
                        <canvas id="fcfChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scenario Analysis -->
        <div class="filters" id="scenarioFilters">
            <h3 style="margin-bottom: 0.75rem; font-size: 1.1rem;">Filter Scenarios</h3>
            <input type="text" class="search-input" id="searchInput" placeholder="Search scenarios...">
            <div id="filterControls">
                <div class="loading">Loading filters...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Scenario Analysis</h2>
                <p class="card-description">Detailed valuation outcomes for each MCF combination</p>
            </div>
            
            <div class="sort-controls">
                <span style="font-weight: 500; font-size: 0.9rem;">Sort by:</span>
                <button class="sort-btn active" onclick="sortScenarios('price')">Share Price</button>
                <button class="sort-btn" onclick="sortScenarios('upside')">Upside %</button>
                <button class="sort-btn" onclick="sortScenarios('ev')">Enterprise Value</button>
                <button class="sort-btn" onclick="sortScenarios('revenue')">2025 Revenue</button>
                <button class="sort-btn" onclick="sortScenarios('fcf')">2025 FCF</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="scenario-table" id="scenarioTable">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>MCF Combination</th>
                            <th class="sortable" onclick="sortTable('price')">Implied Share Price</th>
                            <th class="sortable" onclick="sortTable('upside')">vs Current Price</th>
                            <th class="sortable" onclick="sortTable('ev')">Enterprise Value</th>
                            <th class="sortable" onclick="sortTable('revenue')">2025 Revenue</th>
                            <th class="sortable" onclick="sortTable('fcf')">2025 FCF</th>
                        </tr>
                    </thead>
                    <tbody id="scenarioTableBody">
                        <tr><td colspan="7" class="loading">Loading scenarios...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let valuationData = null;
        let filteredScenarios = [];
        let activeFilters = {};
        let currentSort = { field: 'price', direction: 'desc' };
        const CURRENT_STOCK_PRICE = 166.99; // Updated with actual HSY current price
        let distributionChart = null;

        async function loadData() {
            try {
                const response = await fetch('./valuation_summary.json');
                valuationData = await response.json();
                // Override with current stock price
                valuationData.market_data_used.stock_price = CURRENT_STOCK_PRICE;
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                document.body.innerHTML = '<div class="container"><div class="card"><h2>Error loading data</h2><p>Please ensure valuation_summary.json is in the same directory as this HTML file.</p></div></div>';
            }
        }

        function initializeDashboard() {
            if (!valuationData) return;

            // Update header
            document.getElementById('companyName').textContent = `${valuationData.metadata.company_name} (${valuationData.metadata.ticker})`;
            document.getElementById('valuationInfo').textContent = `Valuation as of ${valuationData.metadata.valuation_date} • ${valuationData.valuation_scenarios.length} Scenarios • Next Earnings: July 30 - Aug 4, 2025 (est.)`;

            // Initialize all sections
            renderMarketData();
            renderDistributionSummary();
            initializeDistributionChart();
            renderMCFs();
            renderFilters();
            initializeFinancialCharts();
            
            filteredScenarios = valuationData.valuation_scenarios;
            sortAndRenderScenarios();
            
            // Initialize search
            document.getElementById('searchInput').addEventListener('input', handleSearch);
        }

        function renderMarketData() {
            const marketData = valuationData.market_data_used;
            const container = document.getElementById('marketData');
            
            container.innerHTML = `
                <div class="compact-metric">
                    <div class="compact-metric-value">$${marketData.stock_price.toFixed(2)}</div>
                    <div class="compact-metric-label">Current Price</div>
                </div>
                <div class="compact-metric">
                    <div class="compact-metric-value">${(marketData.wacc_consensus * 100).toFixed(1)}%</div>
                    <div class="compact-metric-label">WACC</div>
                </div>
                <div class="compact-metric">
                    <div class="compact-metric-value">${(marketData.risk_free_rate * 100).toFixed(1)}%</div>
                    <div class="compact-metric-label">Risk Free Rate</div>
                </div>
                <div class="compact-metric">
                    <div class="compact-metric-value">${(marketData.terminal_growth_rate * 100).toFixed(1)}%</div>
                    <div class="compact-metric-label">Terminal Growth</div>
                </div>
            `;
        }

        function calculateStatistics(prices) {
            const sorted = [...prices].sort((a, b) => a - b);
            const n = sorted.length;
            
            // Calculate percentiles
            const p5 = sorted[Math.floor(n * 0.05)];
            const p25 = sorted[Math.floor(n * 0.25)];
            const p50 = sorted[Math.floor(n * 0.50)];
            const p75 = sorted[Math.floor(n * 0.75)];
            const p95 = sorted[Math.floor(n * 0.95)];
            
            // Calculate mean, variance, and standard deviation
            const mean = prices.reduce((a, b) => a + b, 0) / n;
            const variance = prices.reduce((sum, price) => sum + Math.pow(price - mean, 2), 0) / (n - 1);
            const stdDev = Math.sqrt(variance);
            
            return { p5, p25, p50, p75, p95, mean, variance, stdDev, min: sorted[0], max: sorted[n-1] };
        }

        function renderDistributionSummary() {
            const scenarios = valuationData.valuation_scenarios;
            const prices = scenarios.map(s => s.valuation_results.implied_share_price);
            const stats = calculateStatistics(prices);
            const currentPrice = valuationData.market_data_used.stock_price;
            
            document.getElementById('distributionSummary').innerHTML = `
                <div class="dist-stat">
                    <div class="dist-stat-value">$${stats.p5.toFixed(2)}</div>
                    <div class="dist-stat-label">5% VaR</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${stats.p25.toFixed(2)}</div>
                    <div class="dist-stat-label">P25</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${stats.p50.toFixed(2)}</div>
                    <div class="dist-stat-label">Median</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${stats.p75.toFixed(2)}</div>
                    <div class="dist-stat-label">P75</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${stats.p95.toFixed(2)}</div>
                    <div class="dist-stat-label">P95</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">$${stats.mean.toFixed(2)}</div>
                    <div class="dist-stat-label">Mean</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">${stats.stdDev.toFixed(2)}</div>
                    <div class="dist-stat-label">Std Dev</div>
                </div>
                <div class="dist-stat">
                    <div class="dist-stat-value">${((stats.mean - currentPrice) / currentPrice * 100).toFixed(1)}%</div>
                    <div class="dist-stat-label">Mean Upside</div>
                </div>
            `;
        }

        function renderMCFs() {
            const mcfs = valuationData.mcf_summary;
            const container = document.getElementById('mcfGrid');
            
            container.innerHTML = mcfs.map(mcf => `
                <div class="mcf-card">
                    <div class="mcf-title">${mcf.mcf_name}</div>
                    <div class="mcf-mapping">Model Driver: ${mcf.model_driver_mapping}</div>
                </div>
            `).join('');
        }

        function renderFilters() {
            const mcfs = valuationData.mcf_summary;
            const filterControls = document.getElementById('filterControls');
            
            filterControls.innerHTML = mcfs.map((mcf, index) => `
                <div class="filter-group">
                    <label class="filter-label">${mcf.mcf_name}</label>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setFilter('mcf_${String(index + 1).padStart(2, '0')}', 'all')">All</button>
                        <button class="filter-btn" onclick="setFilter('mcf_${String(index + 1).padStart(2, '0')}', 'bull')">Bull</button>
                        <button class="filter-btn" onclick="setFilter('mcf_${String(index + 1).padStart(2, '0')}', 'base')">Base</button>
                        <button class="filter-btn" onclick="setFilter('mcf_${String(index + 1).padStart(2, '0')}', 'bear')">Bear</button>
                    </div>
                </div>
            `).join('');

            // Initialize filters
            mcfs.forEach((_, index) => {
                activeFilters[`mcf_${String(index + 1).padStart(2, '0')}`] = 'all';
            });
        }

        function setFilter(mcfKey, value) {
            activeFilters[mcfKey] = value;
            
            // Update button states
            const filterGroup = event.target.closest('.filter-group');
            filterGroup.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            applyFilters();
        }

        function applyFilters() {
            filteredScenarios = valuationData.valuation_scenarios.filter(scenario => {
                return Object.keys(activeFilters).every(mcfKey => {
                    const filterValue = activeFilters[mcfKey];
                    if (filterValue === 'all') return true;
                    
                    return scenario.scenario_choices[mcfKey] === filterValue;
                });
            });
            
            sortAndRenderScenarios();
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let searchFiltered = valuationData.valuation_scenarios.filter(scenario => {
                return Object.keys(activeFilters).every(mcfKey => {
                    const filterValue = activeFilters[mcfKey];
                    if (filterValue === 'all') return true;
                    return scenario.scenario_choices[mcfKey] === filterValue;
                });
            });

            if (searchTerm) {
                searchFiltered = searchFiltered.filter(scenario => {
                    const searchableText = [
                        scenario.scenario_name,
                        scenario.scenario_id,
                        ...Object.values(scenario.scenario_choices)
                    ].join(' ').toLowerCase();
                    
                    return searchableText.includes(searchTerm);
                });
            }
            
            filteredScenarios = searchFiltered;
            sortAndRenderScenarios();
        }

        function sortScenarios(field) {
            // Update button states
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentSort.field = field;
            currentSort.direction = 'desc'; // Always descending for these metrics
            sortAndRenderScenarios();
        }

        function sortTable(field) {
            // Toggle direction if same field, otherwise set to descending
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc';
            }
            
            // Update header classes
            document.querySelectorAll('.scenario-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const header = event.target;
            header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            
            sortAndRenderScenarios();
        }

        function sortAndRenderScenarios() {
            const sortField = currentSort.field;
            const sortDirection = currentSort.direction;
            
            filteredScenarios.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortField) {
                    case 'price':
                        aVal = a.valuation_results.implied_share_price;
                        bVal = b.valuation_results.implied_share_price;
                        break;
                    case 'upside':
                        aVal = ((a.valuation_results.implied_share_price - CURRENT_STOCK_PRICE) / CURRENT_STOCK_PRICE);
                        bVal = ((b.valuation_results.implied_share_price - CURRENT_STOCK_PRICE) / CURRENT_STOCK_PRICE);
                        break;
                    case 'ev':
                        aVal = a.valuation_results.enterprise_value;
                        bVal = b.valuation_results.enterprise_value;
                        break;
                    case 'revenue':
                        aVal = a.forecast_summary.revenue['2025'];
                        bVal = b.forecast_summary.revenue['2025'];
                        break;
                    case 'fcf':
                        aVal = a.forecast_summary.unlevered_fcf['2025'];
                        bVal = b.forecast_summary.unlevered_fcf['2025'];
                        break;
                    default:
                        aVal = a.valuation_results.implied_share_price;
                        bVal = b.valuation_results.implied_share_price;
                }
                
                if (sortDirection === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
            
            renderScenarioTable();
        }

        function renderScenarioTable() {
            const tbody = document.getElementById('scenarioTableBody');
            const currentPrice = valuationData.market_data_used.stock_price;
            
            if (filteredScenarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No scenarios match your filters</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredScenarios.map(scenario => {
                const impliedPrice = scenario.valuation_results.implied_share_price;
                const priceChange = ((impliedPrice - currentPrice) / currentPrice * 100);
                const priceChangeClass = priceChange >= 0 ? 'price-above' : 'price-below';
                
                const mcfBadges = Object.entries(scenario.scenario_choices)
                    .map(([mcf, choice]) => `<span class="scenario-badge badge-${choice}">${choice.toUpperCase()}</span>`)
                    .join('');
                
                return `
                    <tr>
                        <td>${scenario.scenario_name}</td>
                        <td>${mcfBadges}</td>
                        <td><strong>$${impliedPrice.toFixed(2)}</strong></td>
                        <td><span class="price-vs-current ${priceChangeClass}">${priceChange > 0 ? '+' : ''}${priceChange.toFixed(1)}%</span></td>
                        <td>$${(scenario.valuation_results.enterprise_value / 1000).toFixed(1)}B</td>
                        <td>$${(scenario.forecast_summary.revenue['2025'] / 1000).toFixed(1)}B</td>
                        <td>$${(scenario.forecast_summary.unlevered_fcf['2025'] / 1000).toFixed(1)}B</td>
                    </tr>
                `;
            }).join('');
        }

        function logNormalPDF(x, mu, sigma) {
            if (x <= 0) return 0;
            const logX = Math.log(x);
            const coefficient = 1 / (x * sigma * Math.sqrt(2 * Math.PI));
            const exponent = -0.5 * Math.pow((logX - mu) / sigma, 2);
            return coefficient * Math.exp(exponent);
        }

        function initializeDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            const prices = valuationData.valuation_scenarios.map(s => s.valuation_results.implied_share_price);
            const currentPrice = valuationData.market_data_used.stock_price;
            const stats = calculateStatistics(prices);
            
            // Create histogram data
            const bins = 30;
            const minPrice = stats.min;
            const maxPrice = stats.max;
            const binSize = (maxPrice - minPrice) / bins;
            
            const histogramData = new Array(bins).fill(0);
            const labels = [];
            
            for (let i = 0; i < bins; i++) {
                const binStart = minPrice + i * binSize;
                const binEnd = binStart + binSize;
                labels.push(`$${binStart.toFixed(0)}`);
                
                histogramData[i] = prices.filter(price => price >= binStart && price < binEnd).length;
            }
            
            // Generate log-normal fit curve (more points for smoother curve)
            const logNormalData = [];
            const logPrices = prices.map(p => Math.log(p));
            const logMean = logPrices.reduce((a, b) => a + b, 0) / logPrices.length;
            const logStd = Math.sqrt(logPrices.reduce((sum, x) => sum + Math.pow(x - logMean, 2), 0) / (logPrices.length - 1));
            
            for (let i = 0; i < bins; i++) {
                const x = minPrice + (i + 0.5) * binSize;
                const density = logNormalPDF(x, logMean, logStd);
                logNormalData.push(density * prices.length * binSize);
            }
            
            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Scenario Count',
                        data: histogramData,
                        backgroundColor: 'rgba(139, 69, 19, 0.6)',
                        borderColor: 'rgba(139, 69, 19, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'Log-Normal Fit',
                        data: logNormalData,
                        type: 'line',
                        borderColor: 'rgba(210, 105, 30, 1)',
                        backgroundColor: 'rgba(210, 105, 30, 0.1)',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Valuation Distribution (Current: $${currentPrice.toFixed(2)}, Mean: $${stats.mean.toFixed(2)}, σ: $${stats.stdDev.toFixed(2)})`
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterLabel: function(context) {
                                    const price = minPrice + (context.dataIndex + 0.5) * binSize;
                                    const logPrice = Math.log(price);
                                    const pValue = 0.5 * (1 + erf((logPrice - logMean) / (logStd * Math.sqrt(2))));
                                    return `P-value: ${(pValue * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frequency'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Share Price ($)'
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            var5: {
                                type: 'line',
                                xMin: stats.p5,
                                xMax: stats.p5,
                                borderColor: 'rgba(220, 38, 38, 0.8)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: '5% VaR',
                                    enabled: true,
                                    position: 'top'
                                }
                            }
                        }
                    }
                }
            });

            // Add VaR line manually since annotation plugin might not be available
            addVarLine(ctx, stats.p5, minPrice, maxPrice);
        }

        // Error function approximation for p-value calculation
        function erf(x) {
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;
            
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x);
            
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            
            return sign * y;
        }

        function addVarLine(ctx, varPrice, minPrice, maxPrice) {
            // This would require manual drawing on canvas or annotation plugin
            // For now, we'll indicate it in the title and tooltip
        }

        function initializeFinancialCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            const fcfCtx = document.getElementById('fcfChart').getContext('2d');
            
            // Sample scenarios for visualization
            const sampleScenarios = [
                {
                    scenario: valuationData.valuation_scenarios.find(s => s.scenario_name.includes('Bull, Bull, Bull, Bull')),
                    label: 'Best Case'
                },
                {
                    scenario: valuationData.valuation_scenarios.find(s => s.scenario_name.includes('Base, Base, Base, Base')),
                    label: 'Consensus'
                },
                {
                    scenario: valuationData.valuation_scenarios.find(s => s.scenario_name.includes('Bear, Bear, Bear, Bear')),
                    label: 'Worst Case'
                }
            ].filter(item => item.scenario);
            
            const years = ['2025', '2026', '2027', '2028', '2029'];
            const colors = ['rgba(240, 230, 140, 0.8)', 'rgba(222, 184, 135, 0.8)', 'rgba(210, 105, 30, 0.8)'];
            
            // Revenue Chart
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: sampleScenarios.map((item, index) => ({
                        label: item.label,
                        data: years.map(year => item.scenario.forecast_summary.revenue[year] / 1000),
                        borderColor: colors[index],
                        backgroundColor: colors[index].replace('0.8', '0.1'),
                        fill: false,
                        tension: 0.1,
                        pointRadius: 3
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Revenue (Billions USD)'
                            }
                        }
                    }
                }
            });
            
            // FCF Chart
            new Chart(fcfCtx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: sampleScenarios.map((item, index) => ({
                        label: item.label,
                        data: years.map(year => item.scenario.forecast_summary.unlevered_fcf[year] / 1000),
                        borderColor: colors[index],
                        backgroundColor: colors[index].replace('0.8', '0.1'),
                        fill: false,
                        tension: 0.1,
                        pointRadius: 3
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Free Cash Flow (Billions USD)'
                            }
                        }
                    }
                }
            });
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html> 